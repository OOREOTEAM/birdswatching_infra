pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws_access_key_id')
        AWS_SECRET_ACCESS_KEY = credentials('aws_secret_access_key')
        AWS_DEFAULT_REGION    = 'eu-central-1'
    }


properties([
    parameters([
        choice(name: 'ENV_NAME', choices: ['dev-01', 'stage-01'], description: 'Select environment'),
      ])
])


    stages {

        stage('Configure Consul server as service') {
            steps {
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'oreo_ssh',
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )
                ]) {
                    dir('ansible') {
                        sh '''
                        export ANSIBLE_HOST_KEY_CHECKING=False
                        ansible-inventory -i aws_ec2.yml --graph
                        ansible-playbook -i aws_ec2.yml consul_server.yml -u ubuntu --private-key "$SSH_KEY" -e env_name=${params.ENV_NAME}
                        '''
                    }
                }
            }
        }

    }
}
