pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID     = credentials('aws_access_key_id')
        AWS_SECRET_ACCESS_KEY = credentials('aws_secret_access_key')
        AWS_DEFAULT_REGION    = 'eu-central-1'

    }

    parameters {
         choice(name: 'ENV_NAME', choices: ['stage-01','dev-01'], description: 'Select environment')
   }
    
    stages {
                stage('Configure web') {
                     steps {
                        withCredentials([
                            sshUserPrivateKey(
                                credentialsId: 'oreo_ssh',
                                keyFileVariable: 'SSH_KEY',
                                usernameVariable: 'SSH_USER'
                            )
                        ]) {
                        sh '''
                            ansible-playbook -i ansible/aws_ec2.yml ansible/lb_install_nginx.yml -u ubuntu \
                            --private-key "$SSH_KEY" \
                            --limit _${ENV_NAME}_nginx_load_balancer \
                            -e "env_name=${ENV_NAME}" \
                            '''
                      }
                  }
                }
    }
}